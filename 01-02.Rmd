## 出生・死亡のシミュレーション

出生と死亡をシミュレーションして、擬似健康保険組合データを作成する。

### 関数を定義する

```{r}
library(magrittr)
library(dplyr)
library(stringr)
library(purrr)
ym_to_t = function(yyyymm = "2022/06"){
  #'  transform YYYY/MM to time value
  #' 
  #' @param yyyymm character : YYYY/MM or YYYY/M
  #' @usage ym_to_t(yyyymm)
  #' @return character (time value)
  tmp = yyyymm %>% str_split("/") %>% .[[1]] %>% as.numeric()
  tmp[2] = tmp[2] - 0.5
  tmp[2] = tmp[2] / 12
  return(as.character(sum(tmp)))
}


t_to_ym = function(time){
  #'  transform time value to YYYY/MM
  #' 
  #' @param time string or numeric : year value (ex. 2022) + month value (ex.0.3),
  #' @usage t_to_ym(time)
  #' @return character : "YYYY/MM"
  time = as.numeric(time)
  year = as.integer(time)
  month = as.integer( (time - year) * 12 ) + 1
  month = max(min(month, 12), 1)
  paste(year, sprintf("%02d", month), sep = "/") %>% return
}

tmp = c("2222/6", "2022/5")
df = data.frame(tmp1 = tmp)


## テスト
df %>% 
  mutate(tmp2 = map_chr(.$tmp, ym_to_t)) %>% 
  mutate(tmp3 = map_chr(.$tmp2, t_to_ym))

```
### 出生のシミュレーション

出征シミュレーション用のデータ読み込み。(01-01で作成したもの)
```{r}
library(readr)
df_birth = read_csv("./data/ipss_birth.csv")
df_birth %>% head

## 0-1の値から、cumsumを参照して、行番号を返す仕組み
vec = df_birth$cum_sum
vec_ = c(0, vec[1:(length(vec)-1)])
dat_row = data.frame(row_num = 1:length(vec), left = vec_, right = vec)
df_birth$left = vec_
df_birth$right = vec

  


```
擬似生成のためのパラメータを設定。

観察期間は、指数分布を使っていい感じに決める。

np.random.exponentialのmuと、rexpのrateは、逆数の関係らしいので、注意する。

```{r}

## 観察期間
start_study_t = 2010   ## 2010年1月
end_study_t = 2019.999 ## 2019年12月

mu = 10 ## 指数分布のパラメータ 観察開始/終了期間が決まる
rate = 1/mu

N = 5000 ## 全体の人数

family_ratio = 0.3 ## 被扶養者が占める割合

```

乱数で保険者を生成する。誕生年の分布は、df_birthに従うことにする。

```{r}
N_ = N * 20
set.seed(71)
random_value = runif(N_)
df_exposure = data.frame(value = random_value)

## 誕生月判定と、曝露期間の設定
df_exposure = df_exposure %>% 
  merge(df_birth, all = TRUE) %>% 
  filter(left <= value) %>% 
  filter(value <= right) %>%
  select(-left, -right, -value) %>% 
  mutate(value = runif(nrow(.))) %>% 
  mutate(value = Year + value) %>% 
  mutate(birth_ym = map_chr(value, t_to_ym)) %>% 
  mutate(value1 = rexp(nrow(.), rate = rate)) %>% 
  mutate(value2 = rexp(nrow(.), rate = rate)) %>% 
  mutate(start_t = start_study_t - mu + value1) %>% 
  mutate(end_t = start_t + value2) %>% 
  filter(start_t >= start_study_t) %>% 
  filter(end_t <= end_study_t) %>% 
  mutate(start_obs_ym = map_chr(start_t, t_to_ym)) %>% 
  mutate(end_obs_ym = map_chr(end_t, t_to_ym)) 

## 被扶養者判定と、後処理
df_exposure = df_exposure %>% 
  mutate(value = runif(nrow(.))) %>% 
  mutate(family = if_else(value < family_ratio, 2, 1 )) %>% ## 1なら本人
  select(-value, -value1, -value2, -start_t, -end_t) %>% 
  mutate(iid = 1:nrow(.)) %>% 
  mutate(iid = paste("i", sprintf("%06d", iid, sep = "")))

## 整形
df_exposure = 
  df_exposure %>% 
  select(iid, Sex, birth_ym, start_obs_ym, end_obs_ym)

## 行数の確保
df_exposure = 
  df_exposure %>% sample_n(size = N, replace = FALSE) 

df_exposure %>% head

```
#### 出生比率の確認
df_birthで集計した真の誕生年比率と、擬似生成した誕生比率を比較してみる。

```{r}
## 擬似生成したデータの誕生年比率集計
df_reproducted_birth =
  df_exposure %>% 
  select(birth_ym) %>% 
  mutate(birth_year = as.integer(substr(birth_ym, 1, 4))) %>% 
  select(-birth_ym) %>% 
  group_by(birth_year) %>% 
  count() %>%  
  mutate(Reproducted_Ratio = n/N) %>% 
  mutate(Year = birth_year) %>% 
  ungroup() %>% 
  select(-n, -birth_year) %>% 
  select(Year, Reproducted_Ratio)

df_reproducted_birth %>% head
```

```{r}
## 真の誕生年比率の集計
df_true_birth = 
  df_birth %>% 
  group_by(Year) %>% 
  summarise(True_Ratio = sum(ratio)) %>%
  mutate(Year = as.integer(Year))

df_true_birth %>% head
```

可視化します。
```{r}
df_birth_compare = merge(df_reproducted_birth, df_true_birth, by = "Year")

library(tidyr)

## 縦持ちして、ggplotします
df_birth_compare_long = 
  df_birth_compare %>% 
  gather(group, value, -Year)

library(ggplot2)
df_birth_compare_long %>% 
  ggplot(aes(x = Year, y = value, color = group)) + 
  geom_line() + 
  ggtitle("Birth Ratio") + 
  theme(legend.position = c(1, 1),
        legend.justification = c(1, 1))

```

...まあ、真の値から上下にブレている...かな...？

1966年は丙午ですね。これで、出生のシミュレーションができました。

### 死亡のシミュレーション

### まとめ
